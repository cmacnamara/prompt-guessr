name: Deploy All (Orchestrator)

on:
  workflow_dispatch:
    inputs:
      run_terraform:
        description: 'Run Terraform Infrastructure'
        required: false
        default: true
        type: boolean
      terraform_action:
        description: 'Terraform action (if enabled)'
        required: false
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
      run_sync_types:
        description: 'Run Sync Shared Types'
        required: false
        default: true
        type: boolean
      run_deploy_backend:
        description: 'Run Deploy Backend'
        required: false
        default: true
        type: boolean
      run_deploy_frontend:
        description: 'Run Deploy Frontend'
        required: false
        default: true
        type: boolean

jobs:
  # Step 1: Provision/verify infrastructure
  terraform:
    name: Terraform
    if: ${{ inputs.run_terraform }}
    uses: ./.github/workflows/terraform.yml
    secrets: inherit
    with:
      action: ${{ inputs.terraform_action }}
  
  # Step 2: Verify types are synced
  sync-types:
    name: Sync Types
    if: ${{ inputs.run_sync_types && !cancelled() }}
    needs: terraform
    uses: ./.github/workflows/sync-types.yml
    secrets: inherit
  
  # Step 3 & 4: Deploy frontend and backend in parallel
  # These are independent and can run simultaneously after sync-types completes
  # This saves deployment time by running both in parallel instead of sequentially
  deploy-backend:
    name: Deploy Backend
    if: ${{ inputs.run_deploy_backend && (always() && !cancelled()) }}
    needs: [sync-types]
    uses: ./.github/workflows/deploy-backend.yml
    secrets: inherit
  
  deploy-frontend:
    name: Deploy Frontend
    if: ${{ inputs.run_deploy_frontend && (always() && !cancelled()) }}
    needs: [sync-types]
    uses: ./.github/workflows/deploy-frontend.yml
    secrets: inherit
  
  summary:
    name: ðŸ“Š Deployment Summary
    needs: [terraform, sync-types, deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          # Function to convert job result to emoji
          result_emoji() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              skipped) echo "â­ï¸" ;;
              cancelled) echo "ðŸš«" ;;
              *) echo "â“" ;;
            esac
          }
          
          # Generate summary
          echo "# ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¯ Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Terraform | $(result_emoji "${{ needs.terraform.result }}") | \`${{ needs.terraform.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Sync Types | $(result_emoji "${{ needs.sync-types.result }}") | \`${{ needs.sync-types.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Backend Deploy | $(result_emoji "${{ needs.deploy-backend.result }}") | \`${{ needs.deploy-backend.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Frontend Deploy | $(result_emoji "${{ needs.deploy-frontend.result }}") | \`${{ needs.deploy-frontend.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.terraform.result }}" == "success" || "${{ needs.terraform.result }}" == "skipped" ]] && \
             [[ "${{ needs.sync-types.result }}" == "success" || "${{ needs.sync-types.result }}" == "skipped" ]] && \
             [[ "${{ needs.deploy-backend.result }}" == "success" || "${{ needs.deploy-backend.result }}" == "skipped" ]] && \
             [[ "${{ needs.deploy-frontend.result }}" == "success" || "${{ needs.deploy-frontend.result }}" == "skipped" ]]; then
            echo "## âœ… Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All deployment stages completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Overall Status: COMPLETED WITH ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more stages failed or were cancelled. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY
