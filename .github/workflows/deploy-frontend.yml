name: Deploy Frontend to Amplify

on:
  push:
    branches:
      - main
    paths:
      - 'prompt-guessr-ui/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: prompt-guessr-ui/package-lock.json
      
      - name: Install dependencies
        working-directory: prompt-guessr-ui
        run: npm ci
      
      - name: Verify environment variables are documented
        working-directory: prompt-guessr-ui
        run: |
          if ! grep -q "NEXT_PUBLIC_API_URL" .env.example; then
            echo "❌ NEXT_PUBLIC_API_URL not documented in .env.example"
            exit 1
          fi
          if ! grep -q "NEXT_PUBLIC_SOCKET_URL" .env.example; then
            echo "❌ NEXT_PUBLIC_SOCKET_URL not documented in .env.example"
            exit 1
          fi
          echo "✅ Environment variables documented"
      
      - name: Build Next.js
        working-directory: prompt-guessr-ui
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://placeholder:3001
          NEXT_PUBLIC_SOCKET_URL: http://placeholder:3001
      
      - name: Run tests (if exist)
        working-directory: prompt-guessr-ui
        run: npm test --if-present

  # Note: Amplify auto-deploys from GitHub when connected
  # This workflow just validates the build succeeds
  notify:
    name: Notify Amplify
    needs: build-check
    runs-on: ubuntu-latest
    
    steps:
      - name: Build status
        run: |
          echo "✅ Frontend build check passed!"
          echo "Amplify will auto-deploy from GitHub repository."
          echo ""
          echo "To monitor deployment:"
          echo "1. Visit AWS Amplify Console"
          echo "2. Select prompt-guessr-frontend app"
          echo "3. View deployment logs for main branch"
