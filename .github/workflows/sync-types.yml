name: Sync Shared Types

on:
  push:
    branches:
      - main
    paths:
      - 'prompt-guessr-backend/shared/**'
      - 'prompt-guessr-ui/shared/**'
  workflow_dispatch:
  workflow_call:

jobs:
  verify-types-sync:
    name: Verify Shared Types are Synced
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Compare shared types directories
        run: ./scripts/sync-types/compare-types.sh
      
      - name: Check TypeScript compilation (backend)
        run: |
          cd prompt-guessr-backend
          npm ci
          npx tsc --noEmit
      
      - name: Check TypeScript compilation (frontend)
        run: |
          cd prompt-guessr-ui
          npm ci
          npx tsc --noEmit

  suggest-symlink-solution:
    name: Suggest Symlink Solution
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Comment with suggestion
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### ⚠️ Shared Types Drift Detected
            
            The shared types between backend and frontend are out of sync.
            
            **Recommended Solution:**
            
            Consider using a symlink or npm workspace to share types:
            
            \`\`\`bash
            # Option 1: Use symlink (local development)
            rm -rf prompt-guessr-ui/shared
            ln -s ../prompt-guessr-backend/shared prompt-guessr-ui/shared
            
            # Option 2: Use npm workspaces (recommended)
            # Create a shared package that both apps import
            \`\`\`
            
            For now, manually sync the files and ensure they match.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
