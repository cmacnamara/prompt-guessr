name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'prompt-guessr-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build & Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: prompt-guessr-backend/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        working-directory: prompt-guessr-backend
        run: |
          echo "::group::Installing dependencies"
          npm ci
          echo "::endgroup::"
          echo "âœ… Dependencies installed"
      
      - name: ğŸ”¨ Build TypeScript
        working-directory: prompt-guessr-backend
        run: |
          echo "::group::Building backend"
          npm run build
          echo "::endgroup::"
          echo "âœ… Build complete"
      
      - name: ğŸ§ª Run tests
        working-directory: prompt-guessr-backend
        run: |
          if npm test --if-present; then
            echo "âœ… Tests passed"
          else
            echo "âš ï¸ No tests found"
          fi
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
          retention-days: 1

  deploy-to-ec2:
    name: ğŸš€ Deploy to EC2
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
      
      - name: ğŸ“¦ Create deployment package
        run: |
          echo "::group::Creating package"
          ./scripts/deploy-backend/create-package.sh
          echo "::endgroup::"
          echo "âœ… Package created"
      
      - name: ğŸ” Configure SSH
        run: |
          echo "::group::Setting up SSH"
          ./scripts/deploy-backend/configure-ssh.sh "${{ secrets.EC2_HOST }}" "${{ secrets.EC2_SSH_KEY }}"
          echo "::endgroup::"
          echo "âœ… SSH configured"
      
      - name: ğŸ“¤ Copy files to EC2
        run: |
          echo "::group::Uploading to EC2"
          ./scripts/deploy-backend/copy-to-ec2.sh "${{ secrets.EC2_HOST }}"
          echo "::endgroup::"
          echo "âœ… Files uploaded"
      
      - name: ğŸš€ Deploy on EC2
        run: |
          echo "::group::Deploying application"
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} \
            "REDIS_URL=${{ secrets.REDIS_URL }} \
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }} \
            IMAGE_PROVIDER=${{ secrets.IMAGE_PROVIDER }} \
            HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }} \
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
            bash -s" < ./scripts/deploy-backend/deploy-on-ec2.sh
          echo "::endgroup::"
          echo "âœ… Deployment complete"
      
      - name: ğŸ¥ Health check
        run: |
          echo "::group::Running health check"
          ./scripts/deploy-backend/health-check.sh "${{ secrets.EC2_HOST }}"
          echo "::endgroup::"
          echo "âœ… Health check passed"
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          ./scripts/deploy-backend/cleanup.sh
          echo "âœ… Cleanup complete"
