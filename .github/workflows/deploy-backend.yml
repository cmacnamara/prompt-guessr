name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'prompt-guessr-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-test:
    name: Build & Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: prompt-guessr-backend/package-lock.json
      
      - name: Install dependencies
        working-directory: prompt-guessr-backend
        run: npm ci
      
      - name: Build TypeScript
        working-directory: prompt-guessr-backend
        run: npm run build
      
      - name: Run tests (if exist)
        working-directory: prompt-guessr-backend
        run: npm test --if-present
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
          retention-days: 1

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
      
      - name: Create deployment package
        run: |
          cd prompt-guessr-backend
          tar -czf deploy.tar.gz \
            dist/ \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            shared/
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Test EC2 host is reachable
          echo "Testing connection to EC2 host: ${{ secrets.EC2_HOST }}"
          
          # Add host key to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || {
            echo "ERROR: Failed to scan SSH keys from EC2 host"
            echo "This usually means:"
            echo "  1. EC2 instance is not running"
            echo "  2. Security group is blocking port 22"
            echo "  3. EC2_HOST secret is incorrect"
            exit 1
          }
      
      - name: Copy files to EC2
        run: |
          scp -i ~/.ssh/id_rsa \
            prompt-guessr-backend/deploy.tar.gz \
            ec2-user@${{ secrets.EC2_HOST }}:/tmp/deploy.tar.gz
      
      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            # Create app directory structure if it doesn't exist
            mkdir -p ~/prompt-guessr/prompt-guessr-backend
            
            # Navigate to app directory
            cd ~/prompt-guessr/prompt-guessr-backend
            
            # Extract deployment package
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Install production dependencies
            npm ci --production
            
            # Update environment variables
            cat > .env << ENVEOF
          NODE_ENV=production
          PORT=3001
          REDIS_URL=${{ secrets.REDIS_URL }}
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          IMAGE_PROVIDER=${{ secrets.IMAGE_PROVIDER }}
          HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION=us-east-1
          ENVEOF
            
            # Restart with PM2
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            pm2 save
            
            echo "✅ Deployment complete!"
          EOF
      
      - name: Health check
        run: |
          sleep 5  # Wait for app to start
          curl -f http://${{ secrets.EC2_HOST }}:3001/health || exit 1
          echo "✅ Health check passed!"
      
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa
