name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'prompt-guessr-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-test:
    name: Build & Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: prompt-guessr-backend/package-lock.json
      
      - name: Install dependencies
        working-directory: prompt-guessr-backend
        run: npm ci
      
      - name: Build TypeScript
        working-directory: prompt-guessr-backend
        run: npm run build
      
      - name: Run tests (if exist)
        working-directory: prompt-guessr-backend
        run: npm test --if-present
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
          retention-days: 1

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: prompt-guessr-backend/dist
      
      - name: Create deployment package
        run: ./scripts/deploy-backend/create-package.sh
      
      - name: Configure SSH
        run: ./scripts/deploy-backend/configure-ssh.sh "${{ secrets.EC2_HOST }}" "${{ secrets.EC2_SSH_KEY }}"
      
      - name: Copy files to EC2
        run: ./scripts/deploy-backend/copy-to-ec2.sh "${{ secrets.EC2_HOST }}"
      
      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} \
            "REDIS_URL=${{ secrets.REDIS_URL }} \
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }} \
            IMAGE_PROVIDER=${{ secrets.IMAGE_PROVIDER }} \
            HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }} \
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
            bash -s" < ./scripts/deploy-backend/deploy-on-ec2.sh
      
      - name: Health check
        run: ./scripts/deploy-backend/health-check.sh "${{ secrets.EC2_HOST }}"
      
      - name: Cleanup
        if: always()
        run: ./scripts/deploy-backend/cleanup.sh
